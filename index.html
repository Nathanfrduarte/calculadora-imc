<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calculadora IMC</title>
    <link rel="stylesheet" href="./css/main.css">
</head>

<body>

    <main>

        <h1>Calculadora de <strong>IMC</strong></h1>
        <form id="formIMC">
            <input type="number" step="0.01" name="peso" placeholder="Digite o peso" required />

            <input type="number" step="0.01" name="altura" placeholder="Digite a altura" required />

            <button type="submit">Calcular</button>

            <div id="result" class="fade-in"></div>
        </form>

        <button id="btn-history">&#128336; Histórico</button>

        <div id="history" class="fade-in">
            <div class="imc-history"></div>
        </div>

    </main>

    <script type="module">
        import IMC from './javascript/imc.js'
        import IMCHistory from './javascript/imcHistory.js'

        const form = document.forms['formIMC']

        form.addEventListener('submit', (event) => {
            event.preventDefault()
        
            if (!form.peso.value || !form.altura.value) return

            const peso = parseFloat(form.peso.value.replace(",", "."))
            const altura = parseFloat(form.altura.value.replace(",", "."))

            const imc = new IMC(peso, altura)
            imc.calcular(peso, altura)

            showResult(imc)

            // Salva os dados no localStorage
            const history = new IMCHistory()
            history.addImc(imc)
        })

        const showResult = (imc) => {
            const divResult = document.getElementById('result')
            
            if (divResult.classList.contains('visible')) {
                divResult.classList.remove('visible')
            }

            divResult.innerHTML = `
                <h3>${imc.imc.toFixed(2)} Kg/m²</h3>
                <h2>${imc.classificacao}</h2>
                <p><strong>O que pode acontecer:</strong></p>
                <p>${imc.consequencia}</p>
            `

            setTimeout(() => divResult.classList.add('visible'), 200)
        }

        const onClickHistory = document.getElementById('btn-history')
        onClickHistory.addEventListener('click', () => {
            const history = new IMCHistory()
            showHistory(history)
        })

        const showHistory = (history) => {

            const divHistoty = document.getElementById('history')
            
            if (divHistoty.classList.contains('visible')) {
                divHistoty.classList.remove('visible')
            }

            // TODO: Colocar a hora junto ao date
            const orderedHistory = history.history.sort((a, b) => b._data - a._data)

            divHistoty.innerHTML = orderedHistory.reduce((template, hist) => {
                const data = new Date(hist._data)

                return template + `
                <div class="imc-history">
                    <p>${data.toLocaleDateString()}</p>
                    <h3>${hist._imc.toFixed(2)} kg/m²</h3>
                    <h2>${hist._classificacao}</h2>
                </div>
                `
            }, '')

            setTimeout(() => divHistoty.classList.add('visible'), 200)
        }

    </script>
</body>

</html>